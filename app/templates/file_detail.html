
<!doctype html><html lang="pt"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CNE MVP - Detalhe {{ file_id }}</title>
<style>
 body{font-family:system-ui,Arial,sans-serif;margin:2rem}
 .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
 .card{border:1px solid #ddd;border-radius:8px;padding:1rem}
 .row{margin-bottom:.75rem} pre{background:#f7f7f7;padding:.8rem;border-radius:6px;overflow:auto;max-height:40vh}
 .btn{display:inline-block;padding:.4rem .8rem;border:1px solid #777;border-radius:6px;text-decoration:none;color:#222;margin-right:.4rem;cursor:pointer}
 .btn:hover{background:#f2f2f2}.muted{color:#777}.small{font-size:12px}.pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid #ccc;background:#fafafa}
</style></head><body>
<h1>Ficheiro <code>{{ file_id }}</code></h1>
<div class="grid">
  <div class="card">
    <h2>1) Processar</h2>
    <div class="row"><button class="btn" onclick="runProcess('AB')">A & B</button></div>
    <pre id="out-process">{}</pre>
    <div class="row small">
      <a class="btn" target="_blank" id="dl-A" href="#">↓ A_records.json</a>
      <a class="btn" target="_blank" id="dl-B" href="#">↓ B_records.json</a>
    </div>
  </div>
  <div class="card">
    <h2>2) Reconciliar</h2>
    <div class="row"><button class="btn" onclick="runReconcile()">Gerar diffs</button></div>
    <pre id="out-reconcile">{}</pre>
    <div class="row small"><a class="btn" target="_blank" id="dl-diffs" href="#">↓ diffs.json</a></div>
  </div>
  <div class="card">
    <h2>3) Validar</h2>
    <div class="row"><button class="btn" onclick="runValidate(true)">Validar (final)</button></div>
    <pre id="out-validate">{}</pre>
    <div class="row small">
      <a class="btn" target="_blank" id="dl-validation" href="#">↓ validation.json</a>
      <a class="btn" target="_blank" id="dl-validated" href="#">↓ validated_records.json</a>
    </div>
  </div>
  <div class="card">
    <h2>4) Exportar</h2>
    <div class="row"><a class="btn" target="_blank" id="dl-csv-final" href="#">↓ CSV (final)</a></div>
  </div>
  <div class="card">
    <h2>5) Modelo B1 (spaCy)</h2>
    <div class="row small">
      <p>Treino/Avaliação/Promoção totalmente offline (JSONL de exemplos com <code>text</code> e <code>spans</code>).</p>
      <ul>
        <li><code>POST /models/train</code>, <code>/models/evaluate</code>, <code>/models/promote</code>, <code>/models/current</code>, <code>/models/infer</code></li>
      </ul>
    </div>
  </div>
</div>
<script>
const fileId="{{ file_id }}";
const setLinks=()=>{
  document.getElementById('dl-A').href=`/artifacts/${fileId}/get?name=A_records.json&kind=working`;
  document.getElementById('dl-B').href=`/artifacts/${fileId}/get?name=B_records.json&kind=working`;
  document.getElementById('dl-diffs').href=`/artifacts/${fileId}/get?name=diffs.json&kind=working`;
  document.getElementById('dl-validation').href=`/artifacts/${fileId}/get?name=validation.json&kind=working`;
  document.getElementById('dl-validated').href=`/artifacts/${fileId}/get?name=validated_records.json&kind=working`;
  document.getElementById('dl-csv-final').href=`/export/${fileId}/csv?source=validated`;
}; setLinks();
async function runProcess(models){const r=await fetch(`/process/${fileId}?models=${models}`,{method:'POST'});const d=await r.json();document.getElementById('out-process').textContent=JSON.stringify(d,null,2);setLinks();}
async function runReconcile(){const r=await fetch(`/reconcile/${fileId}`,{method:'POST'});const d=await r.json();document.getElementById('out-reconcile').textContent=JSON.stringify({auto_accept_count:d.auto_accept_count,needs_review_count:d.needs_review_count,sample:d.diffs.slice(0,5)},null,2);}
async function runValidate(useFinal){const r=await fetch(`/validate/${fileId}?use_final=${useFinal}`,{method:'POST'});const d=await r.json();document.getElementById('out-validate').textContent=JSON.stringify({valid:d.valid,issues_sample:(d.issues||[]).slice(0,20)},null,2);}
</script>
</body></html>
